# This file auto-generated by /home/steveri/tmpdir/pipegen.sh
# Fri Sep 25 13:36:48 PDT 2020

agents: { queue: "papers" }

env:
  GOLD: /build/gold.${BUILDKITE_BUILD_NUMBER}/full_chip

steps:

- label: 'setup'
  commands:
  - 'source mflowgen/bin/setup-buildkite.sh --dir $$GOLD;
     mflowgen run --design $$GARNET_HOME/mflowgen/full_chip'
- wait: ~








########################################################################
# postroute_hold fails sometimes, thus all this infrastructure for retry.
# 
# "prh.sh" does the following:
#   - if step "*-postroute_hold" exists already, do nothing and exit 0
#   - if step does not exist yet, build it
#   - if build fails, rename step to <step>-fail<i> and exit 13
#   - meanwhile tees all outputs to make-prh.log
#   - (if build fails, moves make-prh.log to step dir)
########################################################################

# postroute_hold, retry if fail.
- label: "hold"
  commands:
  - 'source mflowgen/bin/setup-buildkite.sh --dir $$GOLD --need_space 70G;
     echo "--- POSTROUTE_HOLD - FIRST ATTEMPT"; set -o pipefail;
     REF=/sim/buildkite-agent/gold;
     echo "--- $$GARNET_HOME/mflowgen/bin/get-step-context.sh $$REF";
     $$GARNET_HOME/mflowgen/bin/get-step-context.sh $$REF || exit 13;
     echo "--- $$GARNET_HOME/.buildkite/bin/prh.sh";
     $$GARNET_HOME/.buildkite/bin/prh.sh |& tee make-prh1.log'
- wait: { continue_on_failure: true }

# # First retry, continue with another retry on failure.
# - label: "hold'"
#   commands:
#   - 'source mflowgen/bin/setup-buildkite.sh --dir $$GOLD --need_space 70G;
#      echo "--- POSTROUTE_HOLD - SECOND ATTEMPT"; set -o pipefail;
#      $$GARNET_HOME/.buildkite/bin/prh.sh |& tee make-prh2.log'
# - wait: { continue_on_failure: true }
# 
# # Final postroute_hold attempt, fail pipeline if this one bombs.
# - label: "hold''"
#   commands:
#   - 'source mflowgen/bin/setup-buildkite.sh --dir $$GOLD --need_space 70G;
#      echo "--- POSTROUTE_HOLD - FINAL ATTEMPT"; set -o pipefail;
#      $$GARNET_HOME/.buildkite/bin/prh.sh |& tee make-prh3.log'
# - wait: ~
#   
# ########################################################################
# # continue
# ########################################################################
# 
# - label: 'lvs'
#   commands:
#   - 'source mflowgen/bin/setup-buildkite.sh --dir $$GOLD --need_space 61G;
#      echo "--- MAKE MENTOR-CALIBRE-LVS"; set -o pipefail;
#      make mentor-calibre-lvs |& tee make-lvs.log'
# - wait: ~
# 
# # Not sure if this is ever useful...
# # - label: 'drc'
# #   commands:
# #   - 'source mflowgen/bin/setup-buildkite.sh --dir $$GOLD --need_space 18G;
# #      echo "--- MAKE MENTOR-CALIBRE-DRC"; set -o pipefail;
# #      make mentor-calibre-drc |& tee make-drc.log'
# # - wait: ~

