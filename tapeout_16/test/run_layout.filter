#!/bin/bash

# In: 10K lines of streaming run_layout output, see examples/layout19_alex.log
# Out: 100 lines of streaming summary output, see examples/run_layout.sum and below
stdbuf -oL -eL \
awk '
  {pfx=sprintf("%6d  ", NR)} # for debugging
  {pfx=""}

  # Want e.g. ERROR but not "puts ERROR"
  /puts/  { next }

  /LAYER/ { next}
  / 0 error/ { next }
  /ERROR/ { print pfx $0; next }
  /error/ { print pfx $0; next }

  # Strip 3 is where we (used to?) hang forever, see issue 351
  # starting strip 0 left: 0 right 489.996
  # starting strip 1 left: 487.996 right 979.992
  # starting strip 2 left: 977.992 right 1469.988
  # starting strip 3 left: 1467.988 right 1959.984
  # ...
  /starting strip [0-9]/ { print pfx $0; next }

  /Writing Netlist.* pnr.v/ { endtimes=1 }
  /#Start/ && endtimes { print pfx $0; next; }
  /Writing Netlist/ { print pfx $0; next; }
  /Writing GDS/ { print pfx $0; next; }
  /Streamout/ { print ""; print pfx $0; next; }

  /Begin globalDetailRoute/ { print ""; print pfx $0; next; }


  # egrep "% Begin|Done with" | grep -vi save
  /Save|save/ { next }
  /% Begin/          { print pfx $0; next }
  /CCOPT.*Done with/ { print pfx $0; next }

  # ECO: 0.0% of the total area was rechecked for DRC, and 100.0% required routing.
  /# ECO/ {print pfx $0; tot_area = $3; nopt=""; next}
  /violations = 0/ { printf pfx nopt; print $0; nopt="" }
  /0th/ { printviol=1 }
  /optimization iteration/ { nopt=sprintf("  %4s optimization ... ", $2) }
  /number of violations/ {
    if (tot_area == "0.0%") { printviol = 1 }
    if (printviol) {
      printf pfx nopt; print $0; nopt=""; printviol=0;
    }
  }
'
exit

##############################################################################
# SAMPLE OUTPUT
# 
# #% Begin Load MMMC data ... (date=08/09 11:22:01, mem=390.4M)
# #% Begin Load netlist data ... (date=08/09 11:22:07, mem=451.2M)
# **ERROR: (TCLCMD-917):	Cannot find 'library cells' that match 'ts1n16ffcllsblvtc256x32m4sw_ssgnp0p72vm40c/TS1N16FFCLLSBLVTC256X32M4SW' (File results_syn/syn_out._default_constraint_mode_.sdc, Line 5100).
# **ERROR: (TCLCMD-917):	Cannot find 'modules, or cells' that match '' (File results_syn/syn_out._default_constraint_mode_.sdc, Line 5100).
# **ERROR: (TCLCMD-917):	Cannot find 'library cells' that match 'ts1n16ffcllsblvtc256x32m8sw_ssgnp0p72vm40c/TS1N16FFCLLSBLVTC256X32M8SW' (File results_syn/syn_out._default_constraint_mode_.sdc, Line 5101).
# **ERROR: (TCLCMD-917):	Cannot find 'modules, or cells' that match '' (File results_syn/syn_out._default_constraint_mode_.sdc, Line 5101).
# **ERROR: (TCLCMD-917):	Cannot find 'library cells' that match 'ts1n16ffcllsblvtc2048x32m8sw_ssgnp0p72vm40c/TS1N16FFCLLSBLVTC2048X32M8SW' (File results_syn/syn_out._default_constraint_mode_.sdc, Line 5102).
# **ERROR: (TCLCMD-917):	Cannot find 'modules, or cells' that match '' (File results_syn/syn_out._default_constraint_mode_.sdc, Line 5102).
# **ERROR: (TCLCMD-917):	Cannot find 'library cells' that match 'ts1n16ffcllsblvtc2048x64m8sw_ssgnp0p72vm40c/TS1N16FFCLLSBLVTC2048X64M8SW' (File results_syn/syn_out._default_constraint_mode_.sdc, Line 5103).
# **ERROR: (TCLCMD-917):	Cannot find 'modules, or cells' that match '' (File results_syn/syn_out._default_constraint_mode_.sdc, Line 5103).
# #% Begin Load MMMC data ... (date=08/09 11:22:43, mem=1062.2M)
# ERROR     TCLCMD-917           8  Cannot find '%s' that match '%s'         
# *** Message Summary: 71 warning(s), 8 error(s)
# **ERROR: (TCLCMD-917):	Cannot find 'cells' that match '*'
# #% Begin addStripe (date=08/09 11:22:45, mem=1207.1M)
# #% Begin addStripe (date=08/09 11:22:47, mem=1256.5M)
# #% Begin editPowerVia (date=08/09 11:22:47, mem=1256.6M)
# #% Begin addStripe (date=08/09 11:22:47, mem=1256.6M)
# #% Begin addStripe (date=08/09 11:22:47, mem=1257.8M)
# #% Begin editPowerVia (date=08/09 11:22:47, mem=1257.8M)
# #% Begin addStripe (date=08/09 11:22:47, mem=1257.8M)
# #% Begin addStripe (date=08/09 11:22:47, mem=1258.2M)
# #% Begin editPowerVia (date=08/09 11:22:47, mem=1258.2M)
# #% Begin sroute (date=08/09 11:22:47, mem=1258.2M)
# #% Begin editPowerVia (date=08/09 11:22:55, mem=1273.6M)
# #% Begin sroute (date=08/09 11:22:56, mem=1273.7M)
# #% Begin editPowerVia (date=08/09 11:22:56, mem=1277.0M)
# #% Begin editPowerVia (date=08/09 11:22:56, mem=1277.4M)
# #% Begin editPowerVia (date=08/09 11:22:56, mem=1277.4M)
# Writing Netlist "place.enc.dat.tmp/Tile_PE.v.gz" ...
# Writing Netlist "place_opt.enc.dat.tmp/Tile_PE.v.gz" ...
# #% Begin ccopt_design (date=08/09 11:25:47, mem=1800.0M)
# CCOPT: Done with clock implementation routing.
# CCOPT: Done with clock implementation routing.
# 
# % Begin globalDetailRoute (date=08/09 11:26:05, mem=1970.3M)
# # ECO: 12.1% of the total area was rechecked for DRC, and 51.4% required routing.
#   10th optimization ... #   number of violations = 6
#   20th optimization ... #   number of violations = 6
# CCOPT: Done with clock implementation routing.
# Writing Netlist "cts.enc.dat/Tile_PE.v.gz" ...
# Writing Netlist "postcts.enc.dat/Tile_PE.v.gz" ...
# #% Begin routeDesign (date=08/09 11:27:36, mem=2052.1M)
# 
# % Begin globalDetailRoute (date=08/09 11:27:36, mem=2050.2M)
# # ECO: 17.1% of the total area was rechecked for DRC, and 40.7% required routing.
# 
# % Begin globalDetailRoute (date=08/09 11:27:47, mem=2008.4M)
#   10th optimization ... #   number of violations = 2320
#   20th optimization ... #   number of violations = 2259
#   30th optimization ... #   number of violations = 2517
#   40th optimization ... #   number of violations = 2488
#   50th optimization ... #   number of violations = 2396
#   60th optimization ... #   number of violations = 2311
#   70th optimization ... #   number of violations = 2056
# Writing Netlist "route.enc.dat/Tile_PE.v.gz" ...
# # ECO: 20.0% of the total area was rechecked for DRC, and 75.0% required routing.
#   10th optimization ... #   number of violations = 2242
#   20th optimization ... #   number of violations = 2194
#   30th optimization ... #   number of violations = 2524
#   40th optimization ... #   number of violations = 2537
#   50th optimization ... #   number of violations = 2552
#   60th optimization ... #   number of violations = 2358
# Writing Netlist "postRoute.enc.dat/Tile_PE.v.gz" ...
# 
# #% Begin globalDetailRoute (date=08/09 12:30:54, mem=2423.5M)
# # ECO: 0.0% of the total area was rechecked for DRC, and 100.0% required routing.
# #   number of violations = 198
#    1st optimization ... #   number of violations = 16
#    2nd optimization ... #   number of violations = 7
#    3rd optimization ... #   number of violations = 6
#    4th optimization ... #   number of violations = 1
#    5th optimization ... #   number of violations = 0
# #   number of violations = 0
# #Total number of DRC violations = 0
# #Total number of DRC violations = 0
# #Total number of DRC violations = 0
# Writing Netlist "final.enc.dat/Tile_PE.v.gz" ...
# Writing Netlist "pnr.v" ...
# Writing Netlist "pnr.pg.v" ...
# Writing GDSII file ...
# 
# ######Streamout is finished!
# *** Message Summary: 30072 warning(s), 9 error(s)
