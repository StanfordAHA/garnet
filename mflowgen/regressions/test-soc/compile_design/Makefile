ARM_IP_PATH	:= $(abspath $(ARM_IP_DIR))
AHA_IP_PATH := $(abspath $(AHA_IP_DIR))
CUR_DIR  		:= $(dir $(abspath $(firstword $(MAKEFILE_LIST))))

# VCS Options
LINT_OPT	:= +lint=PCWM,TFIPC
VCS_COMPILE_OPTS 	:= -notice +v2k -noIncrComp -debug -full64 +libext+.v+.sv -sverilog -timescale=1ns/1ps $(LINT_OPT)
VCS_COMPILE_OPTS 	+= +define+VCD_ON

# Whether or not to include Garnet CGRA
ifeq ($(SOC_ONLY),True)
	VCS_COMPILE_OPTS += +define+NO_CGRA
endif

# TLX FWD and REV Data Port Partitionning (for pad frame)
VCS_COMPILE_OPTS += +define+TLX_FWD_DATA_LO_WIDTH=$(TLX_FWD_DATA_LO_WIDTH)
VCS_COMPILE_OPTS += +define+TLX_REV_DATA_LO_WIDTH=$(TLX_REV_DATA_LO_WIDTH)

# GLB Read Wait States
VCS_COMPILE_OPTS += +define+CGRA_RD_WS=$(CGRA_RD_WS)

# Testbench File
TBENCH_FILE 			:= tbench_files/Tbench.v

# Design Files
TO_GEN_FILE_LISTS		:= file-list-tbench.vc file-list-aha.vc file-list-cm3.vc \
											 file-list-cmsdk.vc file-list-arm_utils.vc file-list-garnet.vc
AUTO_GEN_FILE_LISTS	:= file-list-nic.vc file-list-dma.vc file-list-tlx.vc
GARNET_FILE_LISTS 	:= -f inputs/filelists/glb.list -f inputs/filelists/glc.list \
												-f inputs/filelists/garnet.list

# Top Design
TOP_DESIGN 	:= $(AHA_IP_DIR)/hardware/logical/AhaGarnetSoC/verilog/AhaGarnetSoC.v

# All File Lists
ALL_FILE_LISTS := $(foreach file,$(TO_GEN_FILE_LISTS),-f $(file))
ALL_FILE_LISTS += $(foreach file,$(AUTO_GEN_FILE_LISTS),-f $(file))
ALL_FILE_LISTS += $(GARNET_FILE_LISTS)

# Main target: use to compile SoC and Testbench
compile: $(TO_GEN_FILE_LISTS) $(AUTO_GEN_FILE_LISTS) pad_frame
	vcs $(VCS_COMPILE_OPTS) $(ALL_FILE_LISTS)  $(TBENCH_FILE) -y pad_frame/genesis_verif | tee vcs_compile.log
	cp -rf simv simv.daidir outputs/


# Helper targets to build ARM IP Generated by Socrates
file-list-nic.vc:
	./vc_expand_paths.py $(ARM_IP_PATH)/logical/nic400_AhaIntegration/nic400/verilog/nic400_AhaIntegration.vc $@

file-list-dma.vc:
	./vc_expand_paths.py $(ARM_IP_PATH)/logical/DMA330_AhaIntegration/logical/pl330_dma_AhaIntegration/pl330_dma_AhaIntegration/verilog/files.vc $@

file-list-tlx.vc:
	./vc_expand_paths.py $(ARM_IP_PATH)/logical/nic400_tlx_AhaIntegration/nic400/verilog/nic400_tlx_AhaIntegration.vc $@

# Helper target to build templated file-list specifications
$(TO_GEN_FILE_LISTS): file-list-%.vc:
	AHA_IP_DIR=$(AHA_IP_PATH) ARM_IP_DIR=$(ARM_IP_PATH) \
	./vc_expand_paths.py file_list_templates/file-list-$*.vc.tmpl $@

pad_frame:
	$(MAKE) -C $(AHA_IP_DIR)/hardware/logical/AhaGarnetSoCPadFrame OUT_DIR=$(CUR_DIR)/pad_frame
